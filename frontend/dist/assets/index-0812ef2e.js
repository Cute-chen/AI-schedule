import{s as Q,e as Ot,a as Mt}from"./index-bcd0f302.js";/* empty css                  *//* empty css                  *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                       *//* empty css                        *//* empty css                        *//* empty css                 */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css                *//* empty css               */import{_ as at}from"./_plugin-vue_export-helper-8da67cfc.js";import{r as D,X as Ae,k as st,S as Ut,y as f,z as S,Q as l,I as a,A as s,u as N,M as c,P as j,a4 as R,H as L,L as M,O as g,J as ot,f as Te,c as G,al as Ce,C as tt,V as Oe}from"./vendor-b2a91a46.js";import{G as zt,ab as Nt,V as jt,U as Rt,E as v,k as le,c as nt,p as rt,X as it,ac as Bt,a7 as dt,a4 as Pt,a5 as Ft,ad as ut,W as ct,Y as qt,_ as pt,ae as Lt,af as Ht,ag as Qt,ah as Gt,M as mt,ai as ft,aj as Jt,ak as Xt,z as Yt,a2 as _t,T as gt,o as Kt,al as Zt,L as el,am as tl,aa as ll,K as Qe,B as al,C as sl,a8 as ol,a6 as nl,S as rl,an as il,r as dl}from"./elementPlus-9365ac08.js";import{s as Ge}from"./settingsService-87306db1.js";/* empty css                  *//* empty css                        *//* empty css                    *//* empty css                    *//* empty css                          *//* empty css                  *//* empty css                 */import{W as lt}from"./WeekRangeSelector-08a2a9b6.js";import"./utils-88d415ea.js";const ul={class:"batch-operation-panel"},cl={class:"panel-header"},pl={class:"operation-tabs"},ml={class:"batch-schedule"},fl={key:0},_l={key:1},gl={key:2},vl={class:"batch-adjust"},yl={class:"type-description"},kl={class:"adjustment-rules"},wl={class:"rule-header"},bl={class:"rule-index"},hl={class:"rule-content"},Sl={class:"from-section"},Wl={class:"arrow-section"},xl={class:"to-section"},Dl={key:0,class:"rule-warning"},Al={key:0,class:"operation-progress"},$l={class:"progress-header"},Vl={class:"progress-details"},Il={key:0},El={key:1,class:"error-message"},Tl={class:"history-list"},Cl={__name:"BatchOperationPanel",props:{employees:{type:Array,default:()=>[]},timeSlots:{type:Array,default:()=>[]},scheduleTemplates:{type:Array,default:()=>[]}},emits:["operationStarted","operationCompleted"],setup(ce,{emit:$e}){const ae=$e,se=D("schedule"),V=D(!1),X=D(!1),P=D(!1),W=D(null),U=D([]),k=Ae({weeks:[],mode:"template",templateId:"",sourceWeek:null,strategy:"fair",requirements:"",overwriteExisting:!1}),x=Ae({weeks:[],type:"single",validationOptions:["checkConflicts","checkAvailability"],adjustments:[{fromEmployee:"",fromTimeSlot:"",toEmployee:"",toTimeSlot:""}]}),pe=p=>{},we=async()=>{if(k.weeks.length===0){v.warning("请选择目标周期");return}if(k.mode==="template"&&!k.templateId){v.warning("请选择模板");return}if(k.mode==="copy"&&!k.sourceWeek){v.warning("请输入源周次");return}try{V.value=!0;let p="",i={};k.mode==="template"?(p="/api/schedules/batch-advanced",i={weeks:k.weeks,templateId:k.templateId,overwriteExisting:k.overwriteExisting}):k.mode==="copy"?(p="/api/schedules/copy",i={sourceWeek:k.sourceWeek,targetWeeks:k.weeks,overwrite:k.overwriteExisting}):k.mode==="ai"&&(p="/api/schedules/auto-schedule",i={weeks:k.weeks,strategy:k.strategy,requirements:k.requirements}),W.value={operation_name:"批量排班",target_weeks:k.weeks,status:"processing",progress:0},_e(),v.success("批量排班已启动"),ae("operationStarted",W.value)}catch{v.error("启动批量排班失败")}finally{V.value=!1}},Y=async()=>{var J,z;if(x.weeks.length===0){v.warning("请选择目标周期");return}const p=x.adjustments.filter(A=>ne(A));if(p.length===0){v.warning("请配置至少一条有效的调班规则");return}if(x.adjustments.some(A=>!ne(A)&&(A.fromEmployee||A.fromTimeSlot||A.toEmployee||A.toTimeSlot))){v.warning("存在无效的调班规则，请检查后重试");return}try{await le.confirm(`确定要对 ${x.weeks.length} 个周期执行 ${p.length} 条调班规则吗？

调班类型：${H(x.type)}`,"确认批量调班",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})}catch{return}try{V.value=!0;const A={weeks:x.weeks,type:x.type,validationOptions:x.validationOptions,adjustments:p.map(C=>({fromEmployee:C.fromEmployee,fromTimeSlot:C.fromTimeSlot,toEmployee:C.toEmployee,toTimeSlot:C.toTimeSlot}))};W.value={operation_name:`批量调班 (${x.type})`,target_weeks:x.weeks,status:"processing",progress:0},_e(),v.success(`批量调班已启动，将处理 ${p.length} 条规则`),ae("operationStarted",W.value)}catch(A){console.error("批量调班失败:",A),v.error(((z=(J=A.response)==null?void 0:J.data)==null?void 0:z.message)||"启动批量调班失败")}finally{V.value=!1}},me=()=>{x.adjustments.push({fromEmployee:"",fromTimeSlot:"",toEmployee:"",toTimeSlot:""})},K=p=>{x.adjustments.splice(p,1)},fe=()=>{Object.assign(k,{weeks:[],mode:"template",templateId:"",sourceWeek:null,strategy:"fair",requirements:"",overwriteExisting:!1})},oe=()=>{Object.assign(x,{weeks:[],type:"single",validationOptions:["checkConflicts","checkAvailability"],adjustments:[{fromEmployee:"",fromTimeSlot:"",toEmployee:"",toTimeSlot:""}]})},H=p=>({single:"单次调班：将指定员工从一个时间段调整到另一个时间段",swap:"员工互换：两个员工之间交换时间段",replace:"批量替换：将某个员工在指定时间段的所有班次替换为另一个员工",pattern:"模式调整：根据预设模式批量调整多个员工的班次"})[p]||"",ne=p=>p.fromEmployee||p.fromTimeSlot,Ve=p=>!p.fromEmployee&&!p.fromTimeSlot?"请至少选择源员工或源时间段":p.fromEmployee===p.toEmployee&&p.fromTimeSlot===p.toTimeSlot?"源和目标不能相同":x.type==="swap"&&(!p.toEmployee||!p.toTimeSlot)?"互换模式需要指定完整的目标员工和时间段":"",_e=()=>{let p=0;const i=setInterval(()=>{p+=Math.random()*20,p>=100?(p=100,W.value.status="completed",W.value.progress=100,W.value.result_summary={total:56,created:52,skipped:4},clearInterval(i),ae("operationCompleted",W.value)):W.value.progress=Math.round(p)},500)},be=async()=>{try{P.value=!0,U.value=[]}catch{v.error("获取操作历史失败")}finally{P.value=!1}},he=p=>{le.alert(JSON.stringify(p,null,2),"操作详情",{customClass:"operation-details-dialog"})},ge=p=>({pending:"info",processing:"warning",completed:"success",failed:"danger"})[p]||"info",I=p=>({pending:"等待中",processing:"处理中",completed:"已完成",failed:"已失败"})[p]||p,b=p=>p?`总计: ${p.total}, 成功: ${p.created||p.success}, 跳过: ${p.skipped||p.failed}`:"",h=p=>new Date(p).toLocaleString("zh-CN");return st(()=>{be()}),Ut(()=>{}),(p,i)=>{const J=nt,z=rt,A=it,C=Bt,re=dt,F=Pt,q=Ft,Me=ut,Ue=ct,Z=qt,ie=pt,ve=Lt,ee=Ht,ze=Qt,Se=Gt,de=mt,Ie=ft,te=Jt,Ne=Xt,je=Yt,Re=_t,Be=gt;return f(),S("div",ul,[l(Re,null,{header:a(()=>[s("div",cl,[i[14]||(i[14]=s("span",null,"批量操作",-1)),l(z,{size:"small",onClick:i[0]||(i[0]=m=>X.value=!X.value)},{default:a(()=>[l(J,null,{default:a(()=>[l(N(zt))]),_:1}),i[13]||(i[13]=c(" 操作历史 ",-1))]),_:1,__:[13]})])]),default:a(()=>[s("div",pl,[l(ze,{modelValue:se.value,"onUpdate:modelValue":i[11]||(i[11]=m=>se.value=m),onTabClick:pe},{default:a(()=>[l(ve,{label:"批量排班",name:"schedule"},{default:a(()=>[s("div",ml,[l(ie,{model:k,"label-width":"100px"},{default:a(()=>[l(A,{label:"目标周期"},{default:a(()=>[l(lt,{modelValue:k.weeks,"onUpdate:modelValue":i[1]||(i[1]=m=>k.weeks=m),title:"选择要排班的周期"},null,8,["modelValue"])]),_:1}),l(A,{label:"排班模式"},{default:a(()=>[l(re,{modelValue:k.mode,"onUpdate:modelValue":i[2]||(i[2]=m=>k.mode=m)},{default:a(()=>[l(C,{label:"template"},{default:a(()=>i[15]||(i[15]=[c("使用模板",-1)])),_:1,__:[15]}),l(C,{label:"copy"},{default:a(()=>i[16]||(i[16]=[c("复制现有排班",-1)])),_:1,__:[16]}),l(C,{label:"ai"},{default:a(()=>i[17]||(i[17]=[c("AI智能排班",-1)])),_:1,__:[17]})]),_:1},8,["modelValue"])]),_:1}),k.mode==="template"?(f(),S("div",fl,[l(A,{label:"选择模板"},{default:a(()=>[l(q,{modelValue:k.templateId,"onUpdate:modelValue":i[3]||(i[3]=m=>k.templateId=m),placeholder:"选择排班模板"},{default:a(()=>[(f(!0),S(j,null,R(ce.scheduleTemplates,m=>(f(),L(F,{key:m.id,label:m.name,value:m.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})])):M("",!0),k.mode==="copy"?(f(),S("div",_l,[l(A,{label:"源周次"},{default:a(()=>[l(Me,{modelValue:k.sourceWeek,"onUpdate:modelValue":i[4]||(i[4]=m=>k.sourceWeek=m),min:1,max:52,placeholder:"要复制的周次"},null,8,["modelValue"])]),_:1})])):M("",!0),k.mode==="ai"?(f(),S("div",gl,[l(A,{label:"排班策略"},{default:a(()=>[l(q,{modelValue:k.strategy,"onUpdate:modelValue":i[5]||(i[5]=m=>k.strategy=m)},{default:a(()=>[l(F,{label:"公平分配",value:"fair"}),l(F,{label:"优先级优先",value:"priority"}),l(F,{label:"经验优化",value:"experience"})]),_:1},8,["modelValue"])]),_:1}),l(A,{label:"特殊要求"},{default:a(()=>[l(Ue,{modelValue:k.requirements,"onUpdate:modelValue":i[6]||(i[6]=m=>k.requirements=m),type:"textarea",rows:3,placeholder:"可选：描述特殊排班要求"},null,8,["modelValue"])]),_:1})])):M("",!0),l(A,{label:"覆盖设置"},{default:a(()=>[l(Z,{modelValue:k.overwriteExisting,"onUpdate:modelValue":i[7]||(i[7]=m=>k.overwriteExisting=m)},{default:a(()=>i[18]||(i[18]=[c(" 覆盖已存在的排班 ",-1)])),_:1,__:[18]},8,["modelValue"])]),_:1}),l(A,null,{default:a(()=>[l(z,{type:"primary",onClick:we,loading:V.value},{default:a(()=>i[19]||(i[19]=[c(" 开始批量排班 ",-1)])),_:1,__:[19]},8,["loading"]),l(z,{onClick:fe},{default:a(()=>i[20]||(i[20]=[c("重置",-1)])),_:1,__:[20]})]),_:1})]),_:1},8,["model"])])]),_:1}),l(ve,{label:"批量调班",name:"adjust"},{default:a(()=>[s("div",vl,[l(ie,{model:x,"label-width":"100px"},{default:a(()=>[l(A,{label:"目标周期"},{default:a(()=>[l(lt,{modelValue:x.weeks,"onUpdate:modelValue":i[8]||(i[8]=m=>x.weeks=m),title:"选择要调班的周期"},null,8,["modelValue"])]),_:1}),l(A,{label:"调班类型"},{default:a(()=>[l(re,{modelValue:x.type,"onUpdate:modelValue":i[9]||(i[9]=m=>x.type=m)},{default:a(()=>[l(C,{label:"single"},{default:a(()=>i[21]||(i[21]=[c("单次调班",-1)])),_:1,__:[21]}),l(C,{label:"swap"},{default:a(()=>i[22]||(i[22]=[c("员工互换",-1)])),_:1,__:[22]}),l(C,{label:"replace"},{default:a(()=>i[23]||(i[23]=[c("批量替换",-1)])),_:1,__:[23]}),l(C,{label:"pattern"},{default:a(()=>i[24]||(i[24]=[c("模式调整",-1)])),_:1,__:[24]})]),_:1},8,["modelValue"]),s("div",yl,g(H(x.type)),1)]),_:1}),l(A,{label:"调班规则"},{default:a(()=>[s("div",kl,[(f(!0),S(j,null,R(x.adjustments,(m,ye)=>(f(),S("div",{key:ye,class:"rule-item"},[s("div",wl,[s("span",bl,"规则 "+g(ye+1),1),l(z,{size:"small",type:"danger",text:"",onClick:$=>K(ye),disabled:x.adjustments.length<=1},{default:a(()=>i[25]||(i[25]=[c(" 删除 ",-1)])),_:2,__:[25]},1032,["onClick","disabled"])]),s("div",hl,[s("div",Sl,[i[26]||(i[26]=s("label",null,"调出:",-1)),l(q,{modelValue:m.fromEmployee,"onUpdate:modelValue":$=>m.fromEmployee=$,placeholder:"选择员工",clearable:""},{default:a(()=>[(f(!0),S(j,null,R(ce.employees,$=>(f(),L(F,{key:$.id,label:$.name,value:$.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]),i[27]||(i[27]=s("span",{class:"connector"},"在",-1)),l(q,{modelValue:m.fromTimeSlot,"onUpdate:modelValue":$=>m.fromTimeSlot=$,placeholder:"选择时间段",clearable:""},{default:a(()=>[(f(!0),S(j,null,R(ce.timeSlots,$=>(f(),L(F,{key:$.id,label:$.name,value:$.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),s("div",Wl,[l(J,{class:"arrow-icon"},{default:a(()=>[l(N(Nt))]),_:1})]),s("div",xl,[i[28]||(i[28]=s("label",null,"调入:",-1)),l(q,{modelValue:m.toEmployee,"onUpdate:modelValue":$=>m.toEmployee=$,placeholder:"选择员工",clearable:""},{default:a(()=>[(f(!0),S(j,null,R(ce.employees,$=>(f(),L(F,{key:$.id,label:$.name,value:$.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]),i[29]||(i[29]=s("span",{class:"connector"},"在",-1)),l(q,{modelValue:m.toTimeSlot,"onUpdate:modelValue":$=>m.toTimeSlot=$,placeholder:"选择时间段",clearable:""},{default:a(()=>[(f(!0),S(j,null,R(ce.timeSlots,$=>(f(),L(F,{key:$.id,label:$.name,value:$.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])]),ne(m)?M("",!0):(f(),S("div",Dl,[l(J,null,{default:a(()=>[l(N(jt))]),_:1}),s("span",null,g(Ve(m)),1)]))]))),128)),l(z,{size:"small",type:"primary",onClick:me},{default:a(()=>[l(J,null,{default:a(()=>[l(N(Rt))]),_:1}),i[30]||(i[30]=c(" 添加调班规则 ",-1))]),_:1,__:[30]})])]),_:1}),l(A,{label:"验证选项"},{default:a(()=>[l(ee,{modelValue:x.validationOptions,"onUpdate:modelValue":i[10]||(i[10]=m=>x.validationOptions=m)},{default:a(()=>[l(Z,{label:"checkConflicts"},{default:a(()=>i[31]||(i[31]=[c("检查时间冲突",-1)])),_:1,__:[31]}),l(Z,{label:"checkAvailability"},{default:a(()=>i[32]||(i[32]=[c("检查员工空闲时间",-1)])),_:1,__:[32]}),l(Z,{label:"allowOverride"},{default:a(()=>i[33]||(i[33]=[c("允许强制调班",-1)])),_:1,__:[33]})]),_:1},8,["modelValue"])]),_:1}),l(A,null,{default:a(()=>[l(z,{type:"primary",onClick:Y,loading:V.value},{default:a(()=>i[34]||(i[34]=[c(" 开始批量调班 ",-1)])),_:1,__:[34]},8,["loading"]),l(z,{onClick:oe},{default:a(()=>i[35]||(i[35]=[c("重置",-1)])),_:1,__:[35]})]),_:1})]),_:1},8,["model"])])]),_:1})]),_:1},8,["modelValue"])]),W.value?(f(),S("div",Al,[l(Se),s("div",$l,[s("h4",null,g(W.value.operation_name),1),l(de,{type:ge(W.value.status)},{default:a(()=>[c(g(I(W.value.status)),1)]),_:1},8,["type"])]),l(Ie,{percentage:W.value.progress,status:W.value.status==="failed"?"exception":void 0},null,8,["percentage","status"]),s("div",Vl,[s("p",null,"目标周期: "+g(W.value.target_weeks.join(", ")),1),W.value.result_summary?(f(),S("p",Il," 结果: "+g(b(W.value.result_summary)),1)):M("",!0),W.value.error_message?(f(),S("p",El," 错误: "+g(W.value.error_message),1)):M("",!0)])])):M("",!0),l(je,{modelValue:X.value,"onUpdate:modelValue":i[12]||(i[12]=m=>X.value=m),title:"批量操作历史",size:"60%"},{default:a(()=>[s("div",Tl,[ot((f(),L(Ne,{data:U.value},{default:a(()=>[l(te,{prop:"operation_name",label:"操作名称"}),l(te,{prop:"target_weeks",label:"目标周期",width:"200"},{default:a(({row:m})=>[c(g(m.target_weeks.join(", ")),1)]),_:1}),l(te,{prop:"status",label:"状态",width:"100"},{default:a(({row:m})=>[l(de,{type:ge(m.status),size:"small"},{default:a(()=>[c(g(I(m.status)),1)]),_:2},1032,["type"])]),_:1}),l(te,{prop:"progress",label:"进度",width:"120"},{default:a(({row:m})=>[l(Ie,{percentage:m.progress,"show-text":!1},null,8,["percentage"])]),_:1}),l(te,{prop:"created_at",label:"创建时间",width:"180"},{default:a(({row:m})=>[c(g(h(m.created_at)),1)]),_:1}),l(te,{label:"操作",width:"100"},{default:a(({row:m})=>[l(z,{size:"small",onClick:ye=>he(m)},{default:a(()=>i[36]||(i[36]=[c("查看",-1)])),_:2,__:[36]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Be,P.value]])])]),_:1},8,["modelValue"])]),_:1})])}}},Ol=at(Cl,[["__scopeId","data-v-79d5adfb"]]);const Ml={class:"schedules-container"},Ul={class:"page-header"},zl={class:"header-actions"},Nl={class:"week-nav"},jl={class:"current-week"},Rl={class:"week-stats"},Bl={class:"calendar-header-controls"},Pl={class:"controls"},Fl={class:"calendar-grid"},ql={class:"calendar-header"},Ll={class:"day-name"},Hl={class:"day-date"},Ql={class:"time-cell"},Gl={class:"time-name"},Jl={class:"time-period"},Xl={class:"required-people"},Yl=["onDrop"],Kl={class:"schedule-content"},Zl=["onDragstart","onClick"],ea={class:"employee-info"},ta={class:"employee-name"},la={class:"schedule-meta"},aa={key:1,class:"confidence"},sa={class:"schedule-actions"},oa=["onClick"],na={key:1,class:"overstaff-warning"},ra={class:"ai-dialog-content"},ia={class:"week-display-info",style:{"margin-top":"8px",padding:"8px",background:"#f5f7fa","border-radius":"4px","font-size":"13px"}},da={style:{color:"#303133","font-weight":"500"}},ua={style:{color:"#666"}},ca={class:"strategy-desc"},pa={style:{display:"flex","justify-content":"space-between","align-items":"center"}},ma={class:"employee-picker"},fa={class:"available-employees"},_a={class:"employee-list"},ga=["onClick"],va={class:"employee-details"},ya={class:"name"},ka={class:"priority"},wa={key:0,class:"reason-content"},ba={class:"confidence-score"},ha={class:"sync-dialog-content"},Sa={class:"source-week-preview",style:{"margin-bottom":"20px"}},Wa={style:{"max-height":"200px","overflow-y":"auto",border:"1px solid #ddd","border-radius":"4px",padding:"10px"}},xa={key:0,style:{color:"#999","text-align":"center",padding:"20px"}},Da={key:1},Aa={key:0,style:{"margin-bottom":"10px"}},$a={style:{"margin-top":"10px"}},Va={class:"strategy-desc",style:{"margin-top":"5px","font-size":"12px",color:"#666"}},Ia={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Ea={style:{"font-size":"12px",color:"#666"}},Ta={class:"batch-delete-dialog-content"},Ca={key:0,style:{"margin-bottom":"10px"}},Oa={style:{"margin-top":"10px"}},Ma={class:"strategy-desc",style:{"margin-top":"5px","font-size":"12px",color:"#666"}},Ua={style:{display:"flex","justify-content":"space-between","align-items":"center"}},za={style:{"font-size":"12px",color:"#e6a23c"}},Na={__name:"index",setup(ce){const $e=async t=>{try{const e=await Ge.getWeekStartDate(),n=Math.floor((t-e)/(24*60*60*1e3));return n<0?0:Math.floor(n/7)+1}catch(e){console.error("Failed to calculate week number:",e);const n=new Date(t.getFullYear(),0,1),o=Math.floor((t-n)/(24*60*60*1e3));return Math.ceil(o/7)}},ae=D(!1),se=D(!1),V=D([]),X=D([]),P=D([]),W=D(new Date),U=D(new Date),k=D(""),x=D(!1),pe=D(!1),we=D(!1),Y=D(!1),me=D(!1),K=D(!1),fe=D(!1),oe=D("");D(null);const H=D("");Te(x,async t=>{t&&(I.weekOffset=0,await Je(0),console.log("AI对话框打开，初始化周次:",{currentWeek:W.value,currentWeekStart:U.value,weekOffset:I.weekOffset,aiFormWeekStart:I.weekStart,aiFormWeekDisplay:oe.value,weekOffsetDescription:H.value}))});const ne=D(null),Ve=D(null),_e=D(null),be=D(""),he=D(0),ge=D(!1),I=Ae({weekStart:new Date,weekOffset:0,strategy:"fair",requirements:""}),b=Ae({targetWeeks:[],targetAbsoluteWeeks:[],targetWeeksText:"",conflictMode:"skip"}),h=Ae({targetWeeks:[],targetAbsoluteWeeks:[],targetWeeksText:"",deleteMode:"cancel"}),p=G(()=>{const t=[],e=U.value;for(let n=0;n<7;n++){const o=new Date(e);o.setDate(e.getDate()+n),t.push({date:o,name:["周日","周一","周二","周三","周四","周五","周六"][o.getDay()]})}return t}),i=G(()=>P.value.reduce((t,e)=>t+e.requiredPeople*7,0)),J=G(()=>V.value.length>0),z=G(()=>{let t=0;return P.value.forEach(e=>{p.value.forEach(n=>{const o=Se(e.id,n.date).length,r=e.requiredPeople;o<r&&(t+=r-o)})}),t}),A=G(()=>z.value===0),C=D(1),re=async()=>{try{const t=await $e(W.value);C.value=t}catch(t){console.error("计算周次失败:",t),C.value=1}},F=G(()=>X.value.filter(t=>t.status==="active")),q=G(()=>{const t=U.value,e=new Date(t);return e.setDate(t.getDate()+6),V.value.filter(n=>{const o=new Date(n.schedule_date);return o>=t&&o<=e}).sort((n,o)=>{const r=new Date(n.schedule_date)-new Date(o.schedule_date);return r!==0?r:(n.time_slot_id||0)-(o.time_slot_id||0)})});G(()=>{const t=[];for(let e=-12;e<=12;e++){if(e===0)continue;new Date(W.value).setDate(W.value.getDate()+e*7);const o=new Date(U.value);o.setDate(U.value.getDate()+e*7);const r=new Date(o);r.setDate(o.getDate()+6),t.push({offset:e,description:e>0?`第${e}周后`:`第${Math.abs(e)}周前`,dateRange:ve(),weekStart:o,weekEnd:r})}return t.sort((e,n)=>e.offset-n.offset)});const Me=G(()=>!b.targetAbsoluteWeeks||b.targetAbsoluteWeeks.length===0?[]:b.targetAbsoluteWeeks.map(t=>{let e,n;return t>1?(e=`第${t}周`,n=`（未来第${t}周，偏移+${t-1}）`):t<0?(e=`前${Math.abs(t)}周`,n=`（过去第${Math.abs(t)}周，偏移${t}）`):(e="当前周",n=""),{absoluteWeek:t,description:e,relativeDescription:n}}).sort((t,e)=>t.absoluteWeek-e.absoluteWeek)),Ue=G(()=>!h.targetAbsoluteWeeks||h.targetAbsoluteWeeks.length===0?[]:h.targetAbsoluteWeeks.map(t=>{let e,n;return t>1?(e=`第${t}周`,n=`（未来第${t}周，偏移+${t-1}）`):t<0?(e=`前${Math.abs(t)}周`,n=`（过去第${Math.abs(t)}周，偏移${t}）`):(e="当前周",n=""),{absoluteWeek:t,description:e,relativeDescription:n}}).sort((t,e)=>t.absoluteWeek-e.absoluteWeek)),Z=async t=>{try{return await Ge.calculateWeekStart(t)}catch(e){console.error("Failed to calculate week start, using default:",e);const n=new Date(t),o=n.getDay(),r=n.getDate()-o+(o===0?-6:1);return new Date(n.setDate(r))}},ie=async t=>{try{const e=await Z(t),n=new Date(e);n.setDate(e.getDate()+6),U.value=e,k.value=`${ee(e)} - ${ee(n)}`}catch(e){console.error("Failed to update week info:",e),k.value="周期计算错误"}},ve=t=>k.value,ee=t=>t.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"}),ze=t=>{const e=new Date;return t.toDateString()===e.toDateString()},Se=(t,e)=>{const n=e.toISOString().split("T")[0];return V.value.filter(o=>o.time_slot_id===t&&o.schedule_date===n)},de=(t,e)=>{const n=P.value.find(r=>r.id===t),o=Se(t,e).length;return n.requiredPeople-o},Ie=async()=>{const t=new Date(W.value);t.setDate(t.getDate()-7),W.value=t,await ie(t),await re(),await Fe()},te=async()=>{const t=new Date(W.value);t.setDate(t.getDate()+7),W.value=t,await ie(t),await re(),await Fe()},Ne=(t,e)=>{ne.value=e.id,t.dataTransfer.setData("scheduleId",e.id)},je=()=>{ne.value=null},Re=async(t,e,n)=>{t.preventDefault();const o=t.dataTransfer.getData("scheduleId");if(o)try{const r=n.toISOString().split("T")[0];await Q.updateSchedule(o,{time_slot_id:e,schedule_date:r});const u=V.value.find(y=>y.id==o);u&&(u.time_slot_id=e,u.schedule_date=r,u.isAISuggestion=!1),v.success("排班已调整")}catch(r){console.error("调整排班失败:",r),v.error("调整失败")}},Be=(t,e)=>{Ve.value=t,_e.value=e,pe.value=!0},m=async t=>{try{const e=_e.value.toISOString().split("T")[0],o=(await Z(_e.value)).toISOString().split("T")[0],r={employee_id:t.id,time_slot_id:Ve.value,week_start_date:o,schedule_date:e,notes:"手动分配"},u=await Q.createSchedule(r);V.value.push(u.data),pe.value=!1,v.success("员工已分配")}catch(e){console.error("分配失败:",e),v.error("分配失败")}},ye=async t=>{try{await le.confirm("确定要删除这个排班吗？","提示"),await Q.deleteSchedule(t.id);const e=V.value.findIndex(n=>n.id===t.id);e>-1&&V.value.splice(e,1),v.success("排班已删除")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),v.error("删除失败"))}},$=t=>{be.value=t.aiReason||"暂无推荐理由",he.value=t.aiConfidence||0,we.value=!0},vt=t=>t>=.8?"#67c23a":t>=.6?"#e6a23c":"#f56c6c",yt=t=>({fair:"尽量让每个员工的班次数量相等，考虑工作量平衡",priority:"根据员工空闲时间优先级和可用性进行排班"})[t]||"",Je=async(t=0)=>{console.log("updateWeekOffsetDisplay 被调用，偏移量:",t);try{const e=new Date(U.value),n=new Date(e);n.setDate(e.getDate()+t*7),console.log("基准周起始:",e),console.log("目标周起始:",n);const o=new Date(n);o.setDate(n.getDate()+6),I.weekStart=n,oe.value=`${ee(n)} - ${ee(o)}`;const r={"-4":"四周前","-3":"三周前","-2":"两周前","-1":"上周",0:"本周（当前）",1:"下周",2:"两周后",3:"三周后",4:"四周后",5:"五周后",6:"六周后",7:"七周后",8:"八周后"};H.value=r[t.toString()]||`第${t>0?"+":""}${t}周`,console.log("更新显示:",{weekStart:n,weekEnd:o,display:oe.value,description:H.value})}catch(e){console.error("更新周偏移显示失败:",e),oe.value="周期计算错误",H.value="计算错误"}},kt=async()=>{var t,e,n;if(!I.weekStart){v.warning("请先选择要排班的周次");return}try{se.value=!0,v.info("正在生成AI排班，请稍候...");const o={weekStart:I.weekStart.toISOString().split("T")[0],weekCount:1,strategy:I.strategy,requirements:I.requirements},r=await Q.autoSchedule(o);if(console.log("前端收到AI排班响应:",r),r.success){const u=r.data||[];console.log("AI排班数据:",{responseData:r.data,aiSchedulesLength:u.length,firstSchedule:u[0]}),V.value=V.value.filter(_=>!_.isAISuggestion);const y=u.map(_=>({id:`ai-${Date.now()}-${Math.random()}`,employee_id:_.employee_id,employee_name:_.employee_name,time_slot_id:_.time_slot_id,time_slot_name:_.time_slot_name,schedule_date:_.schedule_date,week_start_date:_.week_start_date,status:_.status,assigned_method:_.assigned_method,ai_confidence:_.ai_confidence||.8,ai_reason:_.ai_reason||_.notes,notes:_.notes,isAISuggestion:!0,employee:{name:_.employee_name},timeSlot:{name:_.time_slot_name}}));V.value.push(...y),x.value=!1;try{console.log("开始保存AI排班到数据库, 数据:",{schedules:u,schedulesCount:u.length,firstSchedule:u[0]});const _=await Q.applyAISchedule({schedules:u,overwriteExisting:!1});if(console.log("保存AI排班响应:",_),_.success){await Fe();const E=r.summary;E?v.success(`AI排班完成并已保存！为${H.value}生成了 ${E.totalSchedules} 个排班`+(E.failedWeeks>0?`，其中 ${E.failedWeeks} 周生成失败`:"")+'。稍后可使用"同步到其他周"功能快速复制到其他周期。'):v.success(`AI排班已保存！为${H.value}生成${u.length}个排班。稍后可同步到其他周期。`)}else v.warning("AI排班生成成功，但保存时发生错误："+(_.message||"未知错误"))}catch(_){console.error("保存AI排班失败:",_),v.warning("AI排班生成成功，但保存失败，请手动刷新页面查看")}r.errors&&r.errors.length>0&&setTimeout(()=>{v.warning("部分周期排班生成失败，请检查员工空闲时间设置")},1e3)}else v.error(r.message||"AI排班失败"),aiProgressError.value=r.message||"AI排班失败"}catch(o){console.error("AI排班失败:",o);let r;o.code==="ECONNABORTED"||(t=o.message)!=null&&t.includes("timeout")?r="AI排班请求超时，可能是因为排班数据复杂，请稍后重试或联系管理员":r=((n=(e=o.response)==null?void 0:e.data)==null?void 0:n.message)||o.message||"AI排班失败，请检查设置",v.error(r),aiProgressError.value=r}finally{se.value=!1}},wt=async()=>{try{await le.confirm("确定要清空本周所有排班吗？","警告",{type:"warning"});const t=await Z(W.value),e=new Date(t);e.setDate(t.getDate()+6);const n=V.value.filter(o=>{const r=new Date(o.schedule_date);return r>=t&&r<=e});for(const o of n)await Q.deleteSchedule(o.id);V.value=V.value.filter(o=>!n.includes(o)),v.success("已清空本周排班")}catch(t){t!=="cancel"&&(console.error("清空失败:",t),v.error("清空失败"))}},bt=async()=>{try{await le.confirm("（使用前请先检查设置通知开关）确定要向所有员工发送排班通知邮件吗？","发送通知");const t=U.value.toISOString().split("T")[0];await Q.sendNotifications({weekStart:t}),v.success("通知邮件已发送")}catch(t){t!=="cancel"&&(console.error("发送通知失败:",t),v.error("发送通知失败"))}},ht=async()=>{try{const t=await $e(W.value);await le.prompt(`当前是第${t}周，请输入要导出的周次（例如：输入 ${t} 表示当前周，输入 ${t+1} 表示下周）`,"导出排班表",{inputValue:t.toString(),inputPlaceholder:"周次数字",inputValidator:e=>{if(!e)return"请输入周次";const n=parseInt(e);return isNaN(n)?"请输入有效的数字":n<1||n>52?"周次应在1-52之间":!0},inputErrorMessage:"请输入有效的周次"}).then(async({value:e})=>{try{const n=parseInt(e),o=await Ge.getWeekStartDate(),r=new Date(o);r.setDate(o.getDate()+(n-1)*7);const u=r.toISOString().split("T")[0];try{const _=`${{}.VITE_API_BASE_URL||"/api"}/ai-schedule/export/${u}`;console.log("导出URL:",_);const E=document.createElement("a");E.href=_,E.download=`排班表_第${n}周_${u}.xlsx`,E.style.display="none",document.body.appendChild(E),E.click(),document.body.removeChild(E),v.success(`第${n}周排班表导出开始`)}catch(y){console.error("创建下载链接失败:",y),v.error("下载失败，请重试")}}catch(n){console.error("计算周次日期失败:",n),v.error("计算周次对应日期失败")}})}catch(t){t!=="cancel"&&(console.error("导出排班表失败:",t),v.error("导出排班表失败"))}},Xe=()=>{const t=b.targetWeeksText.trim();if(!t){b.targetWeeks=[],b.targetAbsoluteWeeks=[];return}try{const e=new Set,n=new Set,o=t.split(",").map(r=>r.trim()).filter(r=>r);for(const r of o)if(r.includes("-")){const u=r.lastIndexOf("-");let y,_;if(r.startsWith("-"))if(u===0){const w=parseInt(r);if(!isNaN(w)&&w>=-12&&w<=12&&w!==0){const O=w;e.add(O),n.add(w)}continue}else y=parseInt(r.substring(0,u)),_=parseInt(r.substring(u+1));else{const w=r.split("-");y=parseInt(w[0]),_=parseInt(w[1])}if(isNaN(y)||isNaN(_))continue;const E=Math.min(y,_),xe=Math.max(y,_);for(let w=E;w<=xe;w++)if(w>=-12&&w<=12&&w!==1){let O;w<0?O=w:O=w-1,O!==0&&(e.add(O),n.add(w))}}else{const u=parseInt(r);if(!isNaN(u)&&u>=-12&&u<=12&&u!==1){let y;u<0?y=u:y=u-1,y!==0&&(e.add(y),n.add(u))}}b.targetWeeks=Array.from(e).sort((r,u)=>r-u),b.targetAbsoluteWeeks=Array.from(n).sort((r,u)=>r-u)}catch(e){console.error("解析目标周次失败:",e),b.targetWeeks=[],b.targetAbsoluteWeeks=[]}},Ye=(t,e)=>{const n=[];for(let o=t;o<=e;o++)o>=-12&&o<=12&&o!==1&&n.push(o);if(n.length>0){const o=n[0],r=n[n.length-1];b.targetWeeksText=o===r?`${o}`:`${o}-${r}`,Xe()}},St=()=>{b.targetWeeks=[],b.targetAbsoluteWeeks=[],b.targetWeeksText=""},Wt=async()=>{var e,n,o;if(!b.targetAbsoluteWeeks||b.targetAbsoluteWeeks.length===0){v.warning("请选择要同步到的目标周");return}const t=q.value;if(t.length===0){v.warning("当前周没有排班数据可同步");return}try{me.value=!0,await le.confirm(`确定要将当前周的${t.length}个排班同步到${b.targetAbsoluteWeeks.length}个目标周吗？`,"确认同步");const r={sourceWeekStart:U.value.toISOString().split("T")[0],targetWeekOffsets:b.targetWeeks,conflictMode:b.conflictMode,schedules:t.map(y=>({employee_id:y.employee_id,time_slot_id:y.time_slot_id,schedule_date:y.schedule_date,ai_confidence:y.ai_confidence||null,ai_reason:y.ai_reason||null,notes:y.notes||null}))},u=await Q.syncSchedulesToWeeks(r);u.success?(v.success(`成功同步到${u.data.successCount}个周，失败${u.data.failedCount}个`),Y.value=!1,b.targetWeeks=[],b.targetAbsoluteWeeks=[],b.targetWeeksText="",u.data.failedCount>0&&((e=u.data.errors)==null?void 0:e.length)>0&&setTimeout(()=>{const y=u.data.errors.slice(0,3).map(_=>_.message).join("；");v.warning(`部分同步失败：${y}${u.data.errors.length>3?"...":""}`)},1e3)):v.error(u.message||"同步失败")}catch(r){r!=="cancel"&&(console.error("同步排班失败:",r),v.error(((o=(n=r.response)==null?void 0:n.data)==null?void 0:o.message)||"同步排班失败"))}finally{me.value=!1}},Ke=()=>{const t=h.targetWeeksText.trim();if(!t){h.targetWeeks=[],h.targetAbsoluteWeeks=[];return}try{const e=new Set,n=new Set,o=t.split(",").map(r=>r.trim()).filter(r=>r);for(const r of o)if(r.includes("-")){const u=r.lastIndexOf("-");let y,_;if(r.startsWith("-"))if(u===0){const w=parseInt(r);if(!isNaN(w)&&w>=-12&&w<=12&&w!==0){const O=w;e.add(O),n.add(w)}continue}else y=parseInt(r.substring(0,u)),_=parseInt(r.substring(u+1));else{const w=r.split("-");y=parseInt(w[0]),_=parseInt(w[1])}if(isNaN(y)||isNaN(_))continue;const E=Math.min(y,_),xe=Math.max(y,_);for(let w=E;w<=xe;w++)if(w>=-12&&w<=12&&w!==0){let O;w<0?O=w:O=w-1,e.add(O),n.add(w)}}else{const u=parseInt(r);if(!isNaN(u)&&u>=-12&&u<=12&&u!==0){let y;u<0?y=u:y=u-1,e.add(y),n.add(u)}}h.targetWeeks=Array.from(e).sort((r,u)=>r-u),h.targetAbsoluteWeeks=Array.from(n).sort((r,u)=>r-u)}catch(e){console.error("解析批量删除目标周次失败:",e),h.targetWeeks=[],h.targetAbsoluteWeeks=[]}},Pe=t=>{h.targetWeeksText=t,Ke()},Ze=()=>{h.targetWeeks=[],h.targetAbsoluteWeeks=[],h.targetWeeksText=""},xt=async()=>{var t,e,n;if(!h.targetAbsoluteWeeks||h.targetAbsoluteWeeks.length===0){v.warning("请选择要删除的周次范围");return}try{fe.value=!0;const o=h.deleteMode==="permanent"?"永久删除":"软删除",r=h.targetAbsoluteWeeks.map(_=>_<0?`前${Math.abs(_)}周`:_===1?"当前周":`第${_}周`).join("、");await le.confirm(`确定要${o}以下周次的所有排班记录吗？

周次：${r}

⚠️ 此操作${h.deleteMode==="permanent"?"无法恢复":"会将排班状态标记为已取消"}`,"确认删除",{type:"warning",dangerouslyUseHTMLString:!0});const u={weekOffsets:h.targetWeeks,deleteMode:h.deleteMode},y=await Q.batchDeleteSchedulesByWeeks(u);y.success?(v.success(`批量删除完成：${o}了${y.data.deletedCount}个排班记录`),K.value=!1,Ze(),await We(),y.data.failedCount>0&&((t=y.data.errors)==null?void 0:t.length)>0&&setTimeout(()=>{const _=y.data.errors.slice(0,3).map(E=>E.message).join("；");v.warning(`部分删除失败：${_}${y.data.errors.length>3?"...":""}`)},1e3)):v.error(y.message||"批量删除失败")}catch(o){o!=="cancel"&&(console.error("批量删除排班失败:",o),v.error(((n=(e=o.response)==null?void 0:e.data)==null?void 0:n.message)||"批量删除排班失败"))}finally{fe.value=!1}},Dt=async()=>{try{const t=await Ot.getEmployees();X.value=t.data||[]}catch(t){console.error("获取员工列表失败:",t)}},At=async()=>{try{const t=await Mt.getTimeSlots();P.value=Array.isArray(t.data)?t.data:[]}catch(t){console.error("获取时间段失败:",t),P.value=[]}},We=async()=>{try{ae.value=!0;const t=U.value.toISOString().split("T")[0],e=new Date(U.value);e.setDate(e.getDate()+6);const n={dateRange:[t,e.toISOString().split("T")[0]]},o=await Q.getSchedules(n);console.log("获取排班数据响应:",o);const r=o.data;V.value=Array.isArray(r.data)?r.data:Array.isArray(r)?r:[],console.log("解析后的排班数据数量:",V.value.length)}catch(t){console.error("获取排班数据失败:",t),V.value=[]}finally{ae.value=!1}},Fe=async()=>{await We()};Te(W,async t=>{await ie(t),await re(),We()}),Te(Y,t=>{t&&(b.targetWeeks=[],b.targetAbsoluteWeeks=[],b.targetWeeksText="",b.conflictMode="skip")}),Te(K,t=>{t&&(h.targetWeeks=[],h.targetAbsoluteWeeks=[],h.targetWeeksText="",h.deleteMode="cancel")});const $t=t=>{v.success("批量操作已启动")},Vt=t=>{v.success("批量操作已完成"),We()};return st(async()=>{await ie(W.value),await re(),Dt(),At(),We()}),(t,e)=>{const n=nt,o=rt,r=mt,u=_t,y=Ce("QuestionFilled"),_=il,E=Ce("Close"),xe=Ce("Plus"),w=Ce("Warning"),O=ol,It=ut,ue=it,De=nl,qe=dt,Le=ct,He=pt,ke=rl,Et=dl,Tt=ft,Ct=gt;return f(),S("div",Ml,[s("div",Ul,[e[33]||(e[33]=s("div",null,[s("h1",null,"AI智能排班"),s("p",null,"调用AI-api自动生成排班方案")],-1)),s("div",zl,[l(o,{onClick:e[0]||(e[0]=d=>ge.value=!0),type:"success"},{default:a(()=>[l(n,null,{default:a(()=>[l(N(Kt))]),_:1}),e[27]||(e[27]=c(" 批量排班 ",-1))]),_:1,__:[27]}),l(o,{onClick:ht,type:"info"},{default:a(()=>[l(n,null,{default:a(()=>[l(N(Zt))]),_:1}),e[28]||(e[28]=c(" 导出排班表 ",-1))]),_:1,__:[28]}),l(o,{onClick:bt,type:"warning",disabled:!J.value},{default:a(()=>[l(n,null,{default:a(()=>[l(N(el))]),_:1}),e[29]||(e[29]=c(" 邮件通知 ",-1))]),_:1,__:[29]},8,["disabled"]),l(o,{onClick:e[1]||(e[1]=d=>Y.value=!0),type:"success",disabled:!q.value.length},{default:a(()=>[l(n,null,{default:a(()=>[l(N(tl))]),_:1}),e[30]||(e[30]=c(" 同步到其他周 ",-1))]),_:1,__:[30]},8,["disabled"]),l(o,{onClick:e[2]||(e[2]=d=>K.value=!0),type:"danger"},{default:a(()=>[l(n,null,{default:a(()=>[l(N(ll))]),_:1}),e[31]||(e[31]=c(" 批量删除排班 ",-1))]),_:1,__:[31]}),l(o,{onClick:e[3]||(e[3]=d=>x.value=!0),type:"primary",size:"large"},{default:a(()=>[l(n,null,{default:a(()=>[l(N(Qe))]),_:1}),e[32]||(e[32]=c(" AI自动排班 ",-1))]),_:1,__:[32]})])]),l(u,{class:"week-selector"},{default:a(()=>[s("div",Nl,[l(o,{onClick:Ie,icon:N(al)},{default:a(()=>e[34]||(e[34]=[c("上一周",-1)])),_:1,__:[34]},8,["icon"]),s("div",jl,[s("h2",null,g(ve(W.value)),1),s("div",Rl,[l(r,{type:"primary"},{default:a(()=>[c("第"+g(C.value)+"周",1)]),_:1}),l(r,{type:"info"},{default:a(()=>[c("共"+g(i.value)+"个班次",1)]),_:1}),l(r,{type:A.value?"success":"warning"},{default:a(()=>[c(g(A.value?"全部已安排":`还有${z.value}个空缺`),1)]),_:1},8,["type"])])]),l(o,{onClick:te,icon:N(sl)},{default:a(()=>e[35]||(e[35]=[c("下一周",-1)])),_:1,__:[35]},8,["icon"])])]),_:1}),ot((f(),L(u,{class:"schedule-calendar"},{header:a(()=>[s("div",Bl,[e[37]||(e[37]=s("span",null,"排班表",-1)),s("div",Pl,[l(o,{onClick:wt,type:"danger",size:"small",plain:""},{default:a(()=>e[36]||(e[36]=[c(" 清空本周排班 ",-1)])),_:1,__:[36]})])])]),default:a(()=>[s("div",Fl,[s("div",ql,[e[38]||(e[38]=s("div",{class:"time-cell"},"时间段",-1)),(f(!0),S(j,null,R(p.value,d=>(f(),S("div",{key:d.date,class:tt(["day-cell",{today:ze(d.date)}])},[s("div",Ll,g(d.name),1),s("div",Hl,g(ee(d.date)),1)],2))),128))]),(f(!0),S(j,null,R(P.value,d=>(f(),S("div",{key:d.id,class:"time-row"},[s("div",Ql,[s("div",Gl,g(d.name),1),s("div",Jl,g(d.startTime)+" - "+g(d.endTime),1),s("div",Xl,"需要"+g(d.requiredPeople)+"人",1)]),(f(!0),S(j,null,R(p.value,B=>(f(),S("div",{key:`${d.id}-${B.date}`,class:"schedule-cell",onDrop:T=>Re(T,d.id,B.date),onDragover:e[4]||(e[4]=Oe(()=>{},["prevent"])),onDragenter:e[5]||(e[5]=Oe(()=>{},["prevent"]))},[s("div",Kl,[(f(!0),S(j,null,R(Se(d.id,B.date),T=>{var et;return f(),S("div",{key:T.id,class:tt(["scheduled-employee",{"ai-suggested":T.isAISuggestion,"manually-assigned":!T.isAISuggestion,dragging:T.id===ne.value}]),draggable:"true",onDragstart:Ee=>Ne(Ee,T),onDragend:je,onClick:Ee=>t.showScheduleDetails(T)},[s("div",ea,[s("span",ta,g((et=T.employee)==null?void 0:et.name),1),s("div",la,[T.isAISuggestion?(f(),L(n,{key:0,class:"ai-icon"},{default:a(()=>[l(N(Qe))]),_:1})):M("",!0),T.aiConfidence?(f(),S("span",aa,g(Math.round(T.aiConfidence*100))+"% ",1)):M("",!0)])]),s("div",sa,[T.aiReason?(f(),L(_,{key:0,content:"AI推荐理由"},{default:a(()=>[l(o,{size:"small",type:"info",circle:"",onClick:Oe(Ee=>$(T),["stop"])},{default:a(()=>[l(n,null,{default:a(()=>[l(y)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)):M("",!0),l(o,{size:"small",type:"danger",circle:"",onClick:Oe(Ee=>ye(T),["stop"])},{default:a(()=>[l(n,null,{default:a(()=>[l(E)]),_:1})]),_:2},1032,["onClick"])])],42,Zl)}),128)),de(d.id,B.date)>0?(f(),S("div",{key:0,class:"vacancy-slot",onClick:T=>Be(d.id,B.date)},[l(n,null,{default:a(()=>[l(xe)]),_:1}),s("span",null,"还需"+g(de(d.id,B.date))+"人",1)],8,oa)):M("",!0),de(d.id,B.date)<0?(f(),S("div",na,[l(n,null,{default:a(()=>[l(w)]),_:1}),s("span",null,"超额"+g(Math.abs(de(d.id,B.date)))+"人",1)])):M("",!0)])],40,Yl))),128))]))),128))])]),_:1})),[[Ct,ae.value]]),l(ke,{modelValue:x.value,"onUpdate:modelValue":e[10]||(e[10]=d=>x.value=d),title:"AI智能排班",width:"600px"},{footer:a(()=>[s("div",pa,[e[44]||(e[44]=s("div",{style:{"font-size":"12px",color:"#999"}},' 💡 提示：生成排班后可使用"同步到其他周"功能快速复制 ',-1)),s("div",null,[l(o,{onClick:e[9]||(e[9]=d=>x.value=!1)},{default:a(()=>e[43]||(e[43]=[c("取消",-1)])),_:1,__:[43]}),l(o,{type:"primary",onClick:kt,loading:se.value},{default:a(()=>[c(g(se.value?"正在生成...":"生成AI排班"),1)]),_:1},8,["loading"])])])]),default:a(()=>[s("div",ra,[l(O,{title:"AI排班说明",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:a(()=>e[39]||(e[39]=[s("ul",null,[s("li",null,"AI会根据员工空闲时间、历史排班记录进行智能分析"),s("li",null,"考虑员工偏好、工作量平衡、公平性等因素"),s("li",null,"生成的排班方案可以手动调整")],-1)])),_:1}),l(He,{model:I,"label-width":"120px"},{default:a(()=>[l(ue,{label:"目标周次"},{default:a(()=>[l(It,{modelValue:I.weekOffset,"onUpdate:modelValue":e[6]||(e[6]=d=>I.weekOffset=d),min:-4,max:8,placeholder:"0",style:{width:"200px"},onChange:Je},null,8,["modelValue"]),e[40]||(e[40]=s("span",{style:{"margin-left":"10px",color:"#666"}}," (相对当前周的偏移，0=本周，1=下周，-1=上周) ",-1)),s("div",ia,[s("div",da,g(H.value),1),s("div",ua,g(oe.value),1)])]),_:1,__:[40]}),l(ue,{label:"排班策略"},{default:a(()=>[l(qe,{modelValue:I.strategy,"onUpdate:modelValue":e[7]||(e[7]=d=>I.strategy=d)},{default:a(()=>[l(De,{label:"fair"},{default:a(()=>e[41]||(e[41]=[c("公平分配",-1)])),_:1,__:[41]}),l(De,{label:"priority"},{default:a(()=>e[42]||(e[42]=[c("优先级分配",-1)])),_:1,__:[42]})]),_:1},8,["modelValue"]),s("div",ca,g(yt(I.strategy)),1)]),_:1}),l(ue,{label:"特殊要求"},{default:a(()=>[l(Le,{modelValue:I.requirements,"onUpdate:modelValue":e[8]||(e[8]=d=>I.requirements=d),type:"textarea",rows:3,placeholder:"例如：周末需要经验丰富的员工，重要时段需要双人值班等整体要求"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"]),l(ke,{modelValue:pe.value,"onUpdate:modelValue":e[11]||(e[11]=d=>pe.value=d),title:"选择员工",width:"500px"},{default:a(()=>[s("div",ma,[s("div",fa,[s("h3",null,"可用员工 ("+g(F.value.length)+"人)",1),s("div",_a,[(f(!0),S(j,null,R(F.value,d=>(f(),S("div",{key:d.id,class:"employee-option",onClick:B=>m(d)},[l(Et,{size:40},{default:a(()=>[c(g(d.name.charAt(0)),1)]),_:2},1024),s("div",va,[s("div",ya,g(d.name),1),s("div",ka," 优先级: "+g("★".repeat(d.priority||1)),1)]),l(o,{type:"primary",size:"small"},{default:a(()=>e[45]||(e[45]=[c("选择",-1)])),_:1,__:[45]})],8,ga))),128))])])])]),_:1},8,["modelValue"]),l(ke,{modelValue:we.value,"onUpdate:modelValue":e[12]||(e[12]=d=>we.value=d),title:"AI推荐理由",width:"400px"},{default:a(()=>[be.value?(f(),S("div",wa,[l(n,null,{default:a(()=>[l(N(Qe))]),_:1}),s("p",null,g(be.value),1),s("div",ba,[e[46]||(e[46]=s("span",null,"推荐置信度：",-1)),l(Tt,{percentage:Math.round(he.value*100),color:vt(he.value)},null,8,["percentage","color"])])])):M("",!0)]),_:1},8,["modelValue"]),l(ke,{modelValue:ge.value,"onUpdate:modelValue":e[13]||(e[13]=d=>ge.value=d),title:"批量排班操作",width:"800px","close-on-click-modal":!1},{default:a(()=>[l(Ol,{employees:X.value,"time-slots":P.value,onOperationStarted:$t,onOperationCompleted:Vt},null,8,["employees","time-slots"])]),_:1},8,["modelValue"]),l(ke,{modelValue:Y.value,"onUpdate:modelValue":e[19]||(e[19]=d=>Y.value=d),title:"同步排班到其他周",width:"700px"},{footer:a(()=>[s("div",Ia,[s("div",Ea," 已选择 "+g(b.targetAbsoluteWeeks?b.targetAbsoluteWeeks.length:0)+" 个目标周 ",1),s("div",null,[l(o,{onClick:e[18]||(e[18]=d=>Y.value=!1)},{default:a(()=>e[55]||(e[55]=[c("取消",-1)])),_:1,__:[55]}),l(o,{type:"primary",onClick:Wt,loading:me.value,disabled:!b.targetAbsoluteWeeks||b.targetAbsoluteWeeks.length===0},{default:a(()=>[c(g(me.value?"同步中...":"开始同步"),1)]),_:1},8,["loading","disabled"])])])]),default:a(()=>[s("div",ha,[l(O,{title:"同步说明",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:a(()=>e[47]||(e[47]=[s("ul",null,[s("li",null,"将当前周的排班模式完全复制到选择的目标周"),s("li",null,"只复制排班安排，不复制员工的请假等个人信息"),s("li",null,"如果目标周已有排班，可选择覆盖或跳过")],-1)])),_:1}),s("div",Sa,[s("h4",null,"当前周排班预览 ("+g(ve(W.value))+")",1),s("div",Wa,[q.value.length===0?(f(),S("div",xa," 当前周暂无排班数据 ")):(f(),S("div",Da,[(f(!0),S(j,null,R(q.value,d=>{var B,T;return f(),S("div",{key:d.id,style:{display:"flex","justify-content":"space-between",padding:"5px 0","border-bottom":"1px solid #f0f0f0"}},[s("span",null,g((B=d.employee)==null?void 0:B.name),1),s("span",null,g(ee(new Date(d.schedule_date)))+" "+g((T=d.timeSlot)==null?void 0:T.name),1)])}),128))]))])]),l(He,{model:b,"label-width":"100px"},{default:a(()=>[l(ue,{label:"目标周次"},{default:a(()=>[l(Le,{modelValue:b.targetWeeksText,"onUpdate:modelValue":e[14]||(e[14]=d=>b.targetWeeksText=d),placeholder:"例如：2（第2周）、3-6（第3-6周）、-1（前1周）",onInput:Xe,style:{"margin-bottom":"10px"}},null,8,["modelValue"]),e[52]||(e[52]=s("div",{style:{"font-size":"12px",color:"#666","margin-bottom":"10px"}},[s("div",{style:{"margin-bottom":"5px"}},"填写说明（周次序号，当前周为第1周）："),s("div",null,'• 正数表示未来周次：填写 "2" 表示同步到第2周（下周），"6" 表示第6周'),s("div",null,'• 负数表示过去周次：填写 "-1" 表示同步到前1周，"-2" 表示前2周'),s("div",null,'• 范围输入：填写 "2-6" 表示同步到第2周至第6周'),s("div",null,'• 多个选择：填写 "-2,-1,2,6" 表示选择多个周次')],-1)),b.targetAbsoluteWeeks&&b.targetAbsoluteWeeks.length>0?(f(),S("div",Aa,[e[48]||(e[48]=s("div",{style:{"font-size":"12px",color:"#409eff","margin-bottom":"5px"}},"已选择周次：",-1)),(f(!0),S(j,null,R(Me.value,d=>(f(),L(r,{key:d.absoluteWeek,size:"small",style:{"margin-right":"5px","margin-bottom":"5px"}},{default:a(()=>[c(g(d.description)+" "+g(d.relativeDescription),1)]),_:2},1024))),128))])):M("",!0),s("div",$a,[l(o,{size:"small",onClick:e[15]||(e[15]=d=>Ye(2,5))},{default:a(()=>e[49]||(e[49]=[c("快速填写：第2-5周",-1)])),_:1,__:[49]}),l(o,{size:"small",onClick:e[16]||(e[16]=d=>Ye(2,9))},{default:a(()=>e[50]||(e[50]=[c("快速填写：第2-9周",-1)])),_:1,__:[50]}),l(o,{size:"small",onClick:St},{default:a(()=>e[51]||(e[51]=[c("清空",-1)])),_:1,__:[51]})])]),_:1,__:[52]}),l(ue,{label:"冲突处理"},{default:a(()=>[l(qe,{modelValue:b.conflictMode,"onUpdate:modelValue":e[17]||(e[17]=d=>b.conflictMode=d)},{default:a(()=>[l(De,{label:"skip"},{default:a(()=>e[53]||(e[53]=[c("跳过已有排班",-1)])),_:1,__:[53]}),l(De,{label:"overwrite"},{default:a(()=>e[54]||(e[54]=[c("覆盖已有排班",-1)])),_:1,__:[54]})]),_:1},8,["modelValue"]),s("div",Va,g(b.conflictMode==="skip"?"遇到冲突时保留目标周的原有排班":"遇到冲突时用当前周的排班覆盖目标周"),1)]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"]),l(ke,{modelValue:K.value,"onUpdate:modelValue":e[26]||(e[26]=d=>K.value=d),title:"批量删除排班",width:"700px"},{footer:a(()=>[s("div",Ua,[s("div",za," ⚠️ 将删除 "+g(h.targetAbsoluteWeeks?h.targetAbsoluteWeeks.length:0)+" 个周次的所有排班 ",1),s("div",null,[l(o,{onClick:e[25]||(e[25]=d=>K.value=!1)},{default:a(()=>e[64]||(e[64]=[c("取消",-1)])),_:1,__:[64]}),l(o,{type:"danger",onClick:xt,loading:fe.value,disabled:!h.targetAbsoluteWeeks||h.targetAbsoluteWeeks.length===0},{default:a(()=>[c(g(fe.value?"删除中...":"确认删除"),1)]),_:1},8,["loading","disabled"])])])]),default:a(()=>[s("div",Ta,[l(O,{title:"批量删除说明",type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:a(()=>e[56]||(e[56]=[s("ul",null,[s("li",null,[s("strong",null,"此操作将删除指定周次范围内的所有排班记录")]),s("li",null,"例如：删除第1-8周，将删除第1周到第8周的所有值班安排"),s("li",null,"删除后的排班记录将无法恢复，请谨慎操作"),s("li",null,"建议在删除前先确认周次范围是否正确")],-1)])),_:1}),l(He,{model:h,"label-width":"120px"},{default:a(()=>[l(ue,{label:"删除周次范围"},{default:a(()=>[l(Le,{modelValue:h.targetWeeksText,"onUpdate:modelValue":e[20]||(e[20]=d=>h.targetWeeksText=d),placeholder:"例如：1-8（删除第1-8周）、2,4,6（删除第2、4、6周）、-2--1（删除前2周到前1周）",onInput:Ke,style:{"margin-bottom":"10px"}},null,8,["modelValue"]),e[62]||(e[62]=s("div",{style:{"font-size":"12px",color:"#666","margin-bottom":"10px"}},[s("div",{style:{"margin-bottom":"5px"}},"填写说明（周次序号，当前周为第1周）："),s("div",null,'• 正数表示未来周次：填写 "2-8" 表示删除第2周到第8周'),s("div",null,'• 负数表示过去周次：填写 "-4--1" 表示删除前4周到前1周'),s("div",null,'• 混合输入：填写 "-2,1,3-5" 表示删除前2周、第1周、第3-5周'),s("div",null,'• 单个周次：填写 "6" 表示只删除第6周')],-1)),h.targetAbsoluteWeeks&&h.targetAbsoluteWeeks.length>0?(f(),S("div",Ca,[e[57]||(e[57]=s("div",{style:{"font-size":"12px",color:"#e6a23c","margin-bottom":"5px"}},"⚠️ 将要删除的周次：",-1)),(f(!0),S(j,null,R(Ue.value,d=>(f(),L(r,{key:d.absoluteWeek,size:"small",type:"danger",style:{"margin-right":"5px","margin-bottom":"5px"}},{default:a(()=>[c(g(d.description)+" "+g(d.relativeDescription),1)]),_:2},1024))),128))])):M("",!0),s("div",Oa,[l(o,{size:"small",onClick:e[21]||(e[21]=d=>Pe("1-8"))},{default:a(()=>e[58]||(e[58]=[c("快速填写：第1-8周",-1)])),_:1,__:[58]}),l(o,{size:"small",onClick:e[22]||(e[22]=d=>Pe("2-9"))},{default:a(()=>e[59]||(e[59]=[c("快速填写：第2-9周",-1)])),_:1,__:[59]}),l(o,{size:"small",onClick:e[23]||(e[23]=d=>Pe("-4--1"))},{default:a(()=>e[60]||(e[60]=[c("快速填写：前4周",-1)])),_:1,__:[60]}),l(o,{size:"small",onClick:Ze},{default:a(()=>e[61]||(e[61]=[c("清空",-1)])),_:1,__:[61]})])]),_:1,__:[62]}),l(ue,{label:"删除模式"},{default:a(()=>[l(qe,{modelValue:h.deleteMode,"onUpdate:modelValue":e[24]||(e[24]=d=>h.deleteMode=d)},{default:a(()=>[l(De,{label:"permanent"},{default:a(()=>e[63]||(e[63]=[c("永久删除",-1)])),_:1,__:[63]})]),_:1},8,["modelValue"]),s("div",Ma,g(h.deleteMode==="cancel"?" ":"彻底删除排班记录，无法恢复"),1)]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])])}}},ps=at(Na,[["__scopeId","data-v-58376d51"]]);export{ps as default};
