import{u as We,s as ce,a as de,e as xe,b as Ce,c as Te}from"./index-bcd0f302.js";/* empty css                  *//* empty css                   *//* empty css                             *//* empty css                 *//* empty css               */import{_ as qe}from"./_plugin-vue_export-helper-8da67cfc.js";/* empty css                *//* empty css               */import{aC as Ae,r as A,X as N,c as re,k as Ee,y as m,z as h,A as e,O as l,u as g,Q as n,I as i,M as p,J as ue,P as E,a4 as R,C as I,H as U,L as C}from"./vendor-b2a91a46.js";import{B as Re,C as Ie,D as ze,F as Oe,G as $e,H as Me,I as Pe,J as _e,K as Ne,L as Fe,M as Ve,N as Be,c as He,p as Le,O as Ue,P as Ge,d as Je,Q as Qe,R as Ke,S as Xe,T as Ye,U as ve,V as je}from"./elementPlus-9365ac08.js";import{s as me}from"./settingsService-87306db1.js";import"./utils-88d415ea.js";const Ze={class:"dashboard-container"},et={class:"welcome-section"},tt={class:"welcome-text"},st={class:"today-info"},at={class:"last-update"},nt={class:"schedule-overview-section"},lt={class:"section-header"},ot={class:"header-actions"},it={class:"current-week-text"},ct={class:"schedule-table-container"},dt={class:"schedule-calendar desktop-view"},rt={class:"calendar-header"},ut={class:"day-name"},_t={class:"day-date"},vt={class:"time-cell"},mt={class:"time-name"},ht={class:"time-period"},ft={class:"required-people"},pt={class:"schedule-content"},gt=["onClick"],yt={class:"employee-info"},Dt={class:"employee-name"},kt=["onClick"],wt={key:1,class:"overstaff-warning"},St={class:"schedule-list mobile-view"},bt={class:"day-info"},Wt={class:"day-name"},xt={class:"day-date"},Ct={class:"day-status"},Tt={class:"day-time-slots"},qt={class:"slot-header"},At={class:"slot-info"},Et={class:"slot-name"},Rt={class:"slot-time"},It={class:"slot-status"},zt={class:"slot-employees"},Ot=["onClick"],$t=["onClick"],Mt={class:"schedule-summary"},Pt={class:"summary-item"},Nt={class:"value"},Ft={class:"summary-item"},Vt={class:"value success"},Bt={class:"summary-item"},Ht={class:"value warning"},Lt={class:"summary-item"},Ut={class:"value"},Gt={class:"main-content"},Jt={class:"overview-section"},Qt={class:"section-header"},Kt={class:"header-actions"},Xt={class:"core-metrics"},Yt={class:"metric-card"},jt={class:"metric-header"},Zt={class:"metric-icon employee"},es={class:"metric-value"},ts={class:"metric-card"},ss={class:"metric-header"},as={class:"metric-icon availability"},ns={class:"metric-value"},ls={class:"metric-card"},os={class:"metric-header"},is={class:"metric-icon schedule"},cs={class:"metric-value"},ds={class:"metric-header"},rs={class:"metric-icon request"},us={class:"metric-value"},_s={class:"status-card"},vs={class:"card-header"},ms={class:"card-title"},hs={class:"status-grid"},fs={class:"status-service"},ps={class:"service-info"},gs={class:"service-status"},ys={class:"status-service"},Ds={class:"service-info"},ks={class:"service-status"},ws={class:"status-service"},Ss={class:"service-info"},bs={class:"service-status"},Ws={key:0,class:"schedule-detail"},xs={__name:"index",setup(Cs){const X=Ae(),he=We(),F=A(!1),Y=A("未更新"),G=A("加载中..."),J=A("加载中..."),u=N({totalEmployees:0,assignedShifts:0,availabilityCount:0,pendingRequests:0,todayShifts:0,thisWeekTotal:0,completedShifts:0,activeEmployees:0,upcomingShifts:0,recentRequests:0,totalRequests:0}),k=N({connected:!1,text:"未配置",color:"#909399"}),w=N({connected:!1,text:"未配置",color:"#909399"}),b=N({connected:!0,text:"连接正常",color:"#67c23a"});A("schedule");const r=N({currentWeek:new Date,currentWeekStartDate:null,weekSchedules:[],timeSlots:[],loading:!1}),O=A(!1),W=A(null),fe=()=>k.connected&&w.connected&&b.connected?"online":k.connected||w.connected||b.connected?"warning":"offline",Q=async s=>{try{return await me.calculateWeekStart(s)}catch(t){console.error("计算周开始日期失败:",t);const c=new Date(s),_=c.getDay(),d=c.getDate()-_+(_===0?-6:1);return new Date(c.setDate(d))}},pe=s=>s.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),j=async s=>{try{const t=await Q(s);return new Date(t).setDate(t.getDate()+6),`第${await Z(s)}周`}catch(t){return console.error("格式化周范围失败:",t),`第${await Z(s)}周`}},Z=async s=>{try{const t=await me.getWeekStartDate(),c=Math.floor((s-t)/(24*60*60*1e3));return c<0?0:Math.floor(c/7)+1}catch(t){console.error("Failed to calculate week number:",t);const c=new Date(s.getFullYear(),0,1),_=Math.floor((s-c)/(24*60*60*1e3));return Math.ceil(_/7)}},ge=()=>{const s=new Date().getHours();return s<6?"夜深了，注意休息":s<12?"上午好":s<14?"中午好":s<18?"下午好":"晚上好"},ee=s=>s.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"}),te=s=>{const t=new Date;return s.toDateString()===t.toDateString()},K=re(()=>{const s=[];if(!r.currentWeekStartDate)return s;const t=r.currentWeekStartDate;for(let c=0;c<7;c++){const _=new Date(t);_.setDate(t.getDate()+c),s.push({date:_,name:["周日","周一","周二","周三","周四","周五","周六"][_.getDay()]})}return s}),V=re(()=>{const s=r.timeSlots.reduce((_,d)=>_+d.requiredPeople*7,0),t=r.weekSchedules.length,c=Math.max(0,s-t);return{total:s,assigned:t,vacant:c,completionRate:s>0?Math.round(t/s*100):0}}),B=(s,t)=>{const c=t.toISOString().split("T")[0];return r.weekSchedules.filter(_=>_.time_slot_id===s&&_.schedule_date===c)},ye=s=>{const t=s.toISOString().split("T")[0];return r.weekSchedules.filter(c=>c.schedule_date===t)},T=(s,t)=>{const c=r.timeSlots.find(d=>d.id===s);if(!c)return 0;const _=B(s,t).length;return c.requiredPeople-_},$=async()=>{try{const s=await Q(r.currentWeek);r.currentWeekStartDate=s}catch(s){console.error("更新周开始日期失败:",s);const t=new Date(r.currentWeek),c=t.getDay(),_=t.getDate()-c+(c===0?-6:1);r.currentWeekStartDate=new Date(t.setDate(_))}},De=async()=>{const s=new Date(r.currentWeek);s.setDate(s.getDate()-7),r.currentWeek=s,await $(),L(),H()},ke=async()=>{const s=new Date(r.currentWeek);s.setDate(s.getDate()+7),r.currentWeek=s,await $(),L(),H()},se=s=>{W.value=s,O.value=!0},ae=(s,t)=>{X.push("/admin/schedules")},we=()=>{O.value=!1,X.push("/admin/schedules")},ne=async()=>{try{G.value=await j(new Date)}catch(s){console.error("Failed to update current week display:",s),G.value="显示错误"}},H=async()=>{try{J.value=await j(r.currentWeek)}catch(s){console.error("Failed to update schedule week display:",s),J.value="显示错误"}},Se=async()=>{await $(),await Promise.all([le(),oe(),L(),ne(),H()])},L=async()=>{try{r.loading=!0,r.currentWeekStartDate||await $();const s=r.currentWeekStartDate.toISOString().split("T")[0],t=new Date(r.currentWeekStartDate);t.setDate(t.getDate()+6);const c={dateRange:[s,t.toISOString().split("T")[0]]},d=(await ce.getSchedules(c)).data;r.weekSchedules=Array.isArray(d.data)?d.data:Array.isArray(d)?d:[],console.log("值班表数据加载成功:",r.weekSchedules.length,"个排班")}catch(s){console.error("获取值班表数据失败:",s),r.weekSchedules=[]}finally{r.loading=!1}},be=async()=>{try{const s=await de.getTimeSlots();r.timeSlots=Array.isArray(s.data)?s.data:[],console.log("时间段数据加载成功:",r.timeSlots.length,"个时间段")}catch(s){console.error("获取时间段失败:",s),r.timeSlots=[]}},le=async()=>{var s,t,c,_,d;try{F.value=!0;const y=await Q(new Date),x=y.toISOString().split("T")[0],[z,M,D,P]=await Promise.allSettled([xe.getEmployees(),ce.getSchedules({startDate:x}),de.getAvailabilities({}),Ce.getShiftRequests({status:"pending"})]);if(z.status==="fulfilled"){const v=((s=z.value.data)==null?void 0:s.data)||z.value.data||[];if(u.totalEmployees=Array.isArray(v)?v.length:0,D.status==="fulfilled"){const S=((t=D.value.data)==null?void 0:t.data)||D.value.data||[],a=new Set(S.map(o=>o.employeeId||o.employee_id).filter(o=>o));u.activeEmployees=a.size}console.log("员工数据:",v,"总数:",u.totalEmployees,"活跃:",u.activeEmployees)}if(M.status==="fulfilled"){const v=((c=M.value.data)==null?void 0:c.data)||M.value.data||[];if(u.assignedShifts=Array.isArray(v)?v.length:0,v.length>0){const S=new Date().toISOString().split("T")[0],a=new Date;u.todayShifts=v.filter(o=>{const f=o.date||o.schedule_date||o.shiftDate;return f&&f.split("T")[0]===S}).length,u.completedShifts=v.filter(o=>{const f=new Date(o.date||o.schedule_date||o.shiftDate),q=o.endTime||o.end_time||"18:00";return new Date(f.toISOString().split("T")[0]+"T"+q)<a}).length,u.upcomingShifts=u.assignedShifts-u.completedShifts}console.log("排班数据:",v,"总数:",u.assignedShifts,"今日:",u.todayShifts)}if(D.status==="fulfilled"){const v=((_=D.value.data)==null?void 0:_.data)||D.value.data||[];if(u.availabilityCount=Array.isArray(v)?v.length:0,v.length>0){const S=new Date(y);S.setDate(y.getDate()+6);const a=S.toISOString().split("T")[0];u.thisWeekTotal=v.filter(o=>{const f=o.date||o.available_date;return f&&f>=x&&f<=a}).length}console.log("空闲数据:",v,"总数:",u.availabilityCount,"本周:",u.thisWeekTotal)}if(P.status==="fulfilled"){const v=((d=P.value.data)==null?void 0:d.data)||P.value.data||[];if(u.pendingRequests=Array.isArray(v)?v.length:0,u.totalRequests=v.length,v.length>0){const S=new Date(Date.now()-864e5);u.recentRequests=v.filter(a=>new Date(a.createdAt||a.created_at||a.requestDate)>S).length}console.log("申请数据:",v,"待处理:",u.pendingRequests,"最近:",u.recentRequests)}}catch(y){console.error("获取Dashboard数据失败:",y)}finally{F.value=!1,Y.value=new Date().toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}},oe=async()=>{try{const t=(await Te.getSystemHealth()).data||{},c=t.ai||{};k.connected=!!c.connected,k.text=c.text||(c.connected?"已配置":"未配置"),k.color=c.connected?"#67c23a":"#909399";const _=t.email||{};w.connected=!!_.connected,w.text=_.text||(_.connected?"已配置":"未配置"),w.color=_.connected?"#67c23a":"#909399";const d=t.database||{};b.connected=!!d.connected,b.text=d.text||(d.connected?"连接正常":"连接异常"),b.color=d.connected?"#67c23a":"#f56c6c"}catch(s){console.error("检查系统状态失败:",s),k.connected=!1,k.text="检查失败",k.color="#f56c6c",w.connected=!1,w.text="检查失败",w.color="#f56c6c",b.connected=!1,b.text="检查失败",b.color="#f56c6c"}};return Ee(async()=>{await $(),await Promise.all([le(),oe(),be(),L(),ne(),H()])}),(s,t)=>{const c=Ve,_=Be,d=He,y=Le,x=Ue,z=Ge,M=Je,D=Qe,P=Ke,v=Xe,S=Ye;return m(),h("div",Ze,[e("div",et,[e("div",tt,[e("h1",null,"👋 欢迎，"+l(g(he).username)+"！",1),e("p",null,"今天是 "+l(pe(new Date))+"，"+l(ge()),1)]),e("div",st,[n(c,{type:"info",size:"large"},{default:i(()=>[p(l(G.value),1)]),_:1}),e("div",at,[n(_,{type:"info",size:"small"},{default:i(()=>[p(" 数据更新: "+l(Y.value),1)]),_:1})])])]),e("div",nt,[e("div",lt,[t[8]||(t[8]=e("div",{class:"header-content"},[e("h2",null,"📅 本周值班表"),e("p",null,"快速查看和管理本周排班安排")],-1)),e("div",ot,[n(y,{size:"small",onClick:De},{default:i(()=>[n(d,null,{default:i(()=>[n(g(Re))]),_:1}),t[5]||(t[5]=p(" 上周 ",-1))]),_:1,__:[5]}),e("span",it,l(J.value),1),n(y,{size:"small",onClick:ke},{default:i(()=>[t[6]||(t[6]=p(" 下周 ",-1)),n(d,null,{default:i(()=>[n(g(Ie))]),_:1})]),_:1,__:[6]}),n(y,{type:"primary",size:"small",onClick:t[0]||(t[0]=a=>s.$router.push("/admin/schedules"))},{default:i(()=>t[7]||(t[7]=[p(" 管理排班 ",-1)])),_:1,__:[7]})])]),ue((m(),h("div",ct,[e("div",dt,[e("div",rt,[t[9]||(t[9]=e("div",{class:"time-cell"},"时间段",-1)),(m(!0),h(E,null,R(K.value,a=>(m(),h("div",{key:a.date,class:I(["day-cell",{today:te(a.date)}])},[e("div",ut,l(a.name),1),e("div",_t,l(ee(a.date)),1)],2))),128))]),(m(!0),h(E,null,R(r.timeSlots,a=>(m(),h("div",{key:a.id,class:"time-row"},[e("div",vt,[e("div",mt,l(a.name),1),e("div",ht,l(a.startTime)+" - "+l(a.endTime),1),e("div",ft,"需要"+l(a.requiredPeople)+"人",1)]),(m(!0),h(E,null,R(K.value,o=>(m(),h("div",{key:`${a.id}-${o.date}`,class:"schedule-cell"},[e("div",pt,[(m(!0),h(E,null,R(B(a.id,o.date),f=>{var q;return m(),h("div",{key:f.id,class:"scheduled-employee",onClick:ie=>se(f)},[e("div",yt,[e("span",Dt,l((q=f.employee)==null?void 0:q.name),1)])],8,gt)}),128)),T(a.id,o.date)>0?(m(),h("div",{key:0,class:"vacancy-slot",onClick:f=>ae(a.id,o.date)},[n(d,null,{default:i(()=>[n(g(ve))]),_:1}),e("span",null,"还需"+l(T(a.id,o.date))+"人",1)],8,kt)):C("",!0),T(a.id,o.date)<0?(m(),h("div",wt,[n(d,null,{default:i(()=>[n(g(je))]),_:1}),e("span",null,"超额"+l(Math.abs(T(a.id,o.date)))+"人",1)])):C("",!0)])]))),128))]))),128))]),e("div",St,[(m(!0),h(E,null,R(K.value,a=>(m(),h("div",{key:a.date,class:"day-schedule"},[e("div",{class:I(["day-header",{today:te(a.date)}])},[e("div",bt,[e("span",Wt,l(a.name),1),e("span",xt,l(ee(a.date)),1)]),e("div",Ct,l(ye(a.date).length)+" / "+l(r.timeSlots.reduce((o,f)=>o+f.requiredPeople,0))+" 人 ",1)],2),e("div",Tt,[(m(!0),h(E,null,R(r.timeSlots,o=>(m(),h("div",{key:o.id,class:"time-slot-card"},[e("div",qt,[e("div",At,[e("div",Et,l(o.name),1),e("div",Rt,l(o.startTime)+" - "+l(o.endTime),1)]),e("div",It,[n(c,{type:T(o.id,a.date)===0?"success":"warning",size:"small"},{default:i(()=>[p(l(B(o.id,a.date).length)+"/"+l(o.requiredPeople),1)]),_:2},1032,["type"])])]),e("div",zt,[(m(!0),h(E,null,R(B(o.id,a.date),f=>{var q;return m(),h("div",{key:f.id,class:"employee-chip",onClick:ie=>se(f)},l((q=f.employee)==null?void 0:q.name),9,Ot)}),128)),T(o.id,a.date)>0?(m(),h("div",{key:0,class:"add-employee-chip",onClick:f=>ae(o.id,a.date)},[n(d,null,{default:i(()=>[n(g(ve))]),_:1}),e("span",null,"+"+l(T(o.id,a.date)),1)],8,$t)):C("",!0)])]))),128))])]))),128))])])),[[S,r.loading]]),e("div",Mt,[n(z,{gutter:16},{default:i(()=>[n(x,{xs:12,sm:6,span:6},{default:i(()=>[e("div",Pt,[t[10]||(t[10]=e("span",{class:"label"},"总班次",-1)),e("span",Nt,l(V.value.total),1)])]),_:1}),n(x,{xs:12,sm:6,span:6},{default:i(()=>[e("div",Ft,[t[11]||(t[11]=e("span",{class:"label"},"已安排",-1)),e("span",Vt,l(V.value.assigned),1)])]),_:1}),n(x,{xs:12,sm:6,span:6},{default:i(()=>[e("div",Bt,[t[12]||(t[12]=e("span",{class:"label"},"空缺",-1)),e("span",Ht,l(V.value.vacant),1)])]),_:1}),n(x,{xs:12,sm:6,span:6},{default:i(()=>[e("div",Lt,[t[13]||(t[13]=e("span",{class:"label"},"完成率",-1)),e("span",Ut,l(V.value.completionRate)+"%",1)])]),_:1})]),_:1})])]),e("div",Gt,[n(z,{gutter:32},{default:i(()=>[n(x,{xs:24,lg:16},{default:i(()=>[e("div",Jt,[e("div",Qt,[t[15]||(t[15]=e("div",{class:"header-content"},[e("h2",null,"📊 数据概览"),e("p",null,"核心业务数据实时统计与趋势分析")],-1)),e("div",Kt,[n(y,{type:"primary",size:"small",icon:g(ze),onClick:Se,loading:F.value},{default:i(()=>t[14]||(t[14]=[p(" 刷新数据 ",-1)])),_:1,__:[14]},8,["icon","loading"])])]),e("div",Xt,[ue((m(),h("div",Yt,[e("div",jt,[e("div",Zt,[n(d,null,{default:i(()=>[n(g(Oe))]),_:1})]),t[16]||(t[16]=e("div",{class:"metric-label"},"员工总数",-1))]),e("div",es,l(u.totalEmployees||0),1)])),[[S,F.value]]),e("div",ts,[e("div",ss,[e("div",as,[n(d,null,{default:i(()=>[n(g($e))]),_:1})]),t[17]||(t[17]=e("div",{class:"metric-label"},"空闲时间",-1))]),e("div",ns,l(u.availabilityCount||0),1)]),e("div",ls,[e("div",os,[e("div",is,[n(d,null,{default:i(()=>[n(g(Me))]),_:1})]),t[18]||(t[18]=e("div",{class:"metric-label"},"排班总数",-1))]),e("div",cs,l(u.assignedShifts||0),1)]),e("div",{class:I(["metric-card",{urgent:u.pendingRequests>0}])},[e("div",ds,[e("div",rs,[n(d,null,{default:i(()=>[n(g(Pe))]),_:1}),u.pendingRequests>0?(m(),U(M,{key:0,value:u.pendingRequests,class:"metric-badge"},null,8,["value"])):C("",!0)]),t[19]||(t[19]=e("div",{class:"metric-label"},"待处理申请",-1))]),e("div",us,l(u.pendingRequests||0),1)],2)])])]),_:1}),n(x,{xs:24,lg:8},{default:i(()=>[e("div",_s,[e("div",vs,[e("div",ms,[n(d,null,{default:i(()=>[n(g(_e))]),_:1}),t[20]||(t[20]=e("span",null,"系统状态",-1))]),e("div",{class:I(["status-indicator",fe()])},t[21]||(t[21]=[e("div",{class:"indicator-dot"},null,-1)]),2)]),e("div",hs,[e("div",fs,[e("div",{class:I(["service-icon",k.connected?"online":"offline"])},[n(d,null,{default:i(()=>[n(g(Ne))]),_:1})],2),e("div",ps,[t[22]||(t[22]=e("div",{class:"service-name"},"AI服务",-1)),e("div",gs,l(k.text),1)]),k.connected?C("",!0):(m(),U(y,{key:0,text:"",type:"primary",size:"small",onClick:t[1]||(t[1]=a=>s.$router.push("/admin/settings"))},{default:i(()=>t[23]||(t[23]=[p(" 配置 ",-1)])),_:1,__:[23]}))]),e("div",ys,[e("div",{class:I(["service-icon",w.connected?"online":"offline"])},[n(d,null,{default:i(()=>[n(g(Fe))]),_:1})],2),e("div",Ds,[t[24]||(t[24]=e("div",{class:"service-name"},"邮件服务",-1)),e("div",ks,l(w.text),1)]),w.connected?C("",!0):(m(),U(y,{key:0,text:"",type:"primary",size:"small",onClick:t[2]||(t[2]=a=>s.$router.push("/admin/settings"))},{default:i(()=>t[25]||(t[25]=[p(" 配置 ",-1)])),_:1,__:[25]}))]),e("div",ws,[e("div",{class:I(["service-icon",b.connected?"online":"offline"])},[n(d,null,{default:i(()=>[n(g(_e))]),_:1})],2),e("div",Ss,[t[26]||(t[26]=e("div",{class:"service-name"},"数据库",-1)),e("div",bs,l(b.text),1)])])])])]),_:1})]),_:1})]),n(v,{modelValue:O.value,"onUpdate:modelValue":t[4]||(t[4]=a=>O.value=a),title:"排班详情",width:"500px"},{footer:i(()=>[n(y,{onClick:t[3]||(t[3]=a=>O.value=!1)},{default:i(()=>t[27]||(t[27]=[p("关闭",-1)])),_:1,__:[27]}),n(y,{type:"primary",onClick:we},{default:i(()=>t[28]||(t[28]=[p(" 管理排班 ",-1)])),_:1,__:[28]})]),default:i(()=>[W.value?(m(),h("div",Ws,[n(P,{column:2,border:""},{default:i(()=>[n(D,{label:"员工姓名"},{default:i(()=>{var a;return[p(l((a=W.value.employee)==null?void 0:a.name),1)]}),_:1}),n(D,{label:"角色"},{default:i(()=>{var a;return[p(l(((a=W.value.employee)==null?void 0:a.role)==="admin"?"管理员":"员工"),1)]}),_:1}),n(D,{label:"排班日期"},{default:i(()=>[p(l(W.value.schedule_date),1)]),_:1}),n(D,{label:"时间段"},{default:i(()=>{var a;return[p(l((a=W.value.timeSlot)==null?void 0:a.name),1)]}),_:1}),n(D,{label:"工作时间",span:2},{default:i(()=>{var a,o;return[p(l((a=W.value.timeSlot)==null?void 0:a.startTime)+" - "+l((o=W.value.timeSlot)==null?void 0:o.endTime),1)]}),_:1}),W.value.notes?(m(),U(D,{key:0,label:"备注",span:2},{default:i(()=>[p(l(W.value.notes),1)]),_:1})):C("",!0)]),_:1})])):C("",!0)]),_:1},8,["modelValue"])])}}},Vs=qe(xs,[["__scopeId","data-v-c044de9c"]]);export{Vs as default};
